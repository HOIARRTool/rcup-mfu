# streamlit_app.py
# -*- coding: utf-8 -*-

import os
import re
import json
import html
from io import BytesIO
from datetime import datetime, date, time
from typing import Any, Dict, List, Optional, Tuple
from textwrap import dedent

import pandas as pd
import requests
import streamlit as st
import gspread

from docx import Document
from docx.shared import Inches
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload


# =========================
# CONFIG / CONSTANTS
# =========================

LOGO_HA_URL = "https://raw.githubusercontent.com/HOIARRTool/appqtbi/main/messageImage_1763018963411.jpg"

UNIT_OPTIONS = [
    "‡∏£‡∏û.‡∏™‡∏ï.‡∏£‡∏û.‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á",
    "‡∏£‡∏û.‡∏™‡∏ï.‡πÅ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°",
    "‡∏£‡∏û.‡∏™‡∏ï.‡πÇ‡∏•‡πä‡∏∞‡∏õ‡πà‡∏≤‡∏´‡πâ‡∏≤",
    "‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡πà‡∏≤‡∏™‡∏∏‡∏î",
    "‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏á‡πÅ‡∏•",
]

# ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö backward-compatible
SHEET_COLUMNS = [
    "record_id",
    "unit_name",                  # ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‚Äù ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    "app_title",
    "event_date",                 # YYYY-MM-DD
    "event_time",                 # HH:MM

    # --- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ compatibility) ---
    "process_step",               # ‡πÄ‡∏î‡∏¥‡∏°: ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ / ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö event_code
    "drug_name",                  # ‡πÄ‡∏î‡∏¥‡∏°: ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    "severity_level",             # A-I ‡∏´‡∏£‡∏∑‡∏≠ 1-5
    "incident_detail",
    "timeline_text",
    "initial_correction",
    "rca_text",
    "rca_image_filename",
    "rca_image_drive_url",
    "development_plan",
    "created_at",
    "created_by",

    # --- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà ---
    "incident_group",             # 4 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà
    "event_code",                 # CPM201 / CPP101 / ...
    "event_topic",                # ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    "severity_scheme",            # "A-I" / "1-5"
    "event_display",              # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° code + topic
]

# ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°
INCIDENT_GROUP_OPTIONS = [
    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå",
    "Patient Safety",
    "Personal Safety",
    "People Safety",
]

EVENT_CODE_MAP: Dict[str, List[Tuple[str, str]]] = {
    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå": [
        ("CPM201", "Medication error : Prescribing (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤)"),
        ("CPM202", "Medication error : Transcribing (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏¢‡∏≤)"),
        ("CPM203", "Medication error : Pre-dispensing (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤)"),
        ("CPM204", "Medication error : Dispensing (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤)"),
        ("CPM205", "Medication error : Administration (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤)"),
        ("CPM101", "‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥"),
        ("CPM102", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Guideline ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ High Alert Drug"),
        ("CPM103", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á"),
        ("CPM104", "Mis selection of a strong potassium containing solution***"),
        ("CPM105", "‡πÅ‡∏û‡πâ‡∏¢‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô ‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥)/ADE: Adverse Drug Events ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö E ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ"),
        ("CPM106", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Guideline ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Fatal Drug"),
        ("CPM107", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á"),
        ("CPM206", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Guideline ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Look-Alike Sound-Alike Medication Names"),
        ("CPM207", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° Look-Alike Sound-Alike Medication Names"),
        ("CPM208", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ Guideline ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô HAD, Fatal drug, Look-Alike Sound-Alike, Antibiotics"),
        ("CPM301", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Guideline ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Medication Reconciliation"),
        ("CPM302", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ Medication Reconciliation"),
        ("CPM303", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ Medication Reconciliation"),
        ("CPM304", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏è‡∏¥‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ Medication Reconciliation"),
        ("CPM401", "‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Guideline ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Rational Drug Use"),
        ("CPM402", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞‡πÉ‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≠‡∏î‡∏•‡∏°‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô‡πÉ‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å"),
        ("CPM403", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞‡πÉ‡∏ô‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡∏£‡πà‡∏ß‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô"),
        ("CPM404", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞)"),
        ("GOI207", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏¢‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û/‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"),
    ],
    "Patient Safety": [
        ("CPL202", "‡∏™‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à"),
        ("CPP101", "Patient Identification"),
        ("CPP201", "‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°/‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"),
        ("CPP204", "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£/‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ú‡∏¥‡∏î/‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô/‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤"),
        ("CPP206", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏°‡∏≤‡∏à‡∏≤‡∏Å Verbal or Telephone Order/Communication"),
        ("CPP303", "(Patient Assessment) ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô/‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏¥‡∏î/‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÇ‡∏£‡∏Ñ"),
        ("CPP405", "‡∏ï‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á/fall"),
        ("CPP601", "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"),
        ("CPP602", "‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠"),
    ],
    "Personal Safety": [
        ("GPE101", "‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏™‡∏á ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á ‡∏°‡∏µ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô"),
        ("GPE205", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥/‡∏ö‡∏≠‡∏Å‡∏ó‡∏≤‡∏á, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πÑ‡∏ü‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ/‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á, ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ï‡∏¥‡∏î‡πÉ‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏ï‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"),
        ("GPE206", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡∏õ‡πÇ‡∏†‡∏Ñ-‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ, ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ/‡∏î‡∏±‡∏ö/‡∏ä‡πá‡∏≠‡∏ï/‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö, ‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢/‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Ç‡∏¢‡∏∞ ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ/‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"),
        ("GPE303", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ß‡∏≤‡∏à‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"),
        ("GPE304", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"),
        ("GPE305", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏á‡∏ö‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏≤‡∏™‡∏∏‡∏£‡∏≤‡∏≠‡∏≤‡∏•‡∏∞‡∏ß‡∏≤‡∏î"),
        ("GPI101", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ñ‡∏π‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏µ‡∏Ñ‡∏°‡∏ó‡∏¥‡πà‡∏°‡∏ï‡∏≥"),
        ("GPI102", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏´‡∏•‡∏±‡πà‡∏á‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏• (mucous membrane and non-intact skin exposure to blood and body fluid)"),
        ("GPI201", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (airborne transmission) ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‡∏ß‡∏±‡∏ì‡πÇ‡∏£‡∏Ñ ‡∏´‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏™‡∏∏‡∏Å‡∏≠‡∏µ‡πÉ‡∏™"),
        ("GPL101", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ö‡∏ô‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"),
        ("GPL104", "‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà"),
        ("GPL106", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î"),
        ("GPM104", "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"),
        ("GPM203", "‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå"),
        ("GPM204", "‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå"),
        ("GPP203", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Physical Hazard"),
        ("GPP212", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Biomechanical Hazard"),
        ("GPS105", "‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Privacy) ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå"),
        ("GPS106", "‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Privacy) ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå"),
        ("GPS203", "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÄ‡∏Å‡∏¥‡∏î‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏≤‡∏á‡∏•‡∏ö‡∏ï‡πà‡∏≠‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"),
    ],
    "People Safety": [
        ("GOI101", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô Hardware/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ/‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ-‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ"),
        ("GOI102", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô Network & Security ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ/‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏°/‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå"),
        ("GOI107", "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°/‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏ä‡πà‡∏ô HIS, LIS, ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏≤ ‡∏•‡πà‡∏°/‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ß‡πâ"),
        ("GOI204", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠-‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠-‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Error of Medical device) ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ/‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ-‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ"),
        ("GOI206", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏¢‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û/‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"),
        ("GOS201", "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°/‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏Ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞"),
        ("GOS202", "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏Å‡∏î‡∏ä‡∏±‡∏Å‡πÇ‡∏Ñ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏•‡∏á/‡∏™‡πâ‡∏ß‡∏°‡πÄ‡∏ï‡πá‡∏°/‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏ä‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏Å‡∏≤‡∏£"),
    ],
}

SEVERITY_OPTIONS_AI = list("ABCDEFGHI")
SEVERITY_OPTIONS_PEOPLE = ["1", "2", "3", "4", "5"]

SEVERITY_DESC_AI = {
    "A": "(‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (No Harm)",
    "B": "(‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏Å‡∏•) ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÉ‡∏î‡πÜ ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (No Harm)",
    "C": "(‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£) ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (Low Harm)",
    "D": "(‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ß‡∏±‡∏á) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (Low Harm)",
    "E": "(‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Moderate Harm)",
    "F": "(‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏ô‡∏≤‡∏ô) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏ô‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Moderate Harm)",
    "G": "(‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏≤‡∏£) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å (Severe Harm)",
    "H": "(‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å (Severe Harm)",
    "I": "(‡∏à‡∏≥‡πÉ‡∏à‡∏•‡∏≤) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ü‡πâ‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏®‡∏≤‡∏•/‡∏™‡∏∑‡πà‡∏≠ ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Death)",
}

SEVERITY_DESC_PEOPLE = {
    "1": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 90%) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1.5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10,000 ‡∏ö‡∏≤‡∏ó",
    "2": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö (‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ) ‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ 81 - 90%) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1.5 - 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 10,001 ‚Äì 100,000 ‡∏ö‡∏≤‡∏ó",
    "3": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö (‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ 71 - 80%) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‚Äì 4.5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 100,001 ‚Äì 500,000 ‡∏ö‡∏≤‡∏ó",
    "4": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ 60 - 70%) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 4.5 - 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 500,001 ‚Äì 10,000,000 ‡∏ö‡∏≤‡∏ó",
    "5": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 60%) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10,000,000 ‡∏ö‡∏≤‡∏ó",
}


# =========================
# PAGE SETUP
# =========================

st.set_page_config(
    page_title="PHOIR",
    page_icon="üè°",
    layout="wide",
)


# =========================
# HELPER: READ CONFIG (ENV ONLY for Render)
# =========================

def _get_env(
    key: str,
    default: Optional[str] = None,
    aliases: Optional[List[str]] = None,
) -> Optional[str]:
    keys = [key] + (aliases or [])
    for k in keys:
        v = os.getenv(k)
        if v is not None and str(v).strip() != "":
            return str(v).strip()
    return default


def get_app_config() -> Dict[str, Any]:
    app_title = _get_env("APP_TITLE", "PHOIR_DEMO")
    unit_name = _get_env("UNIT_NAME", "unknown-unit")
    login_user = _get_env("APP_LOGIN_USERNAME", "")
    login_pass = _get_env("APP_LOGIN_PASSWORD", "")

    gsheet_url = _get_env("GSHEET_URL", "")
    worksheet_name = _get_env("GSHEET_WORKSHEET", "PHOIR_DEMO", aliases=["GHEET_WORKSHEET"])

    gcp_sa_json = _get_env("GCP_SERVICE_ACCOUNT_JSON", "", aliases=["GSHEET_CREDENTIALS_JSON"])
    gemini_api_key = _get_env("GEMINI_API_KEY", "")
    gdrive_folder_id = _get_env("GDRIVE_FOLDER_ID", "")

    return {
        "APP_TITLE": app_title,
        "UNIT_NAME": unit_name,
        "APP_LOGIN_USERNAME": login_user,
        "APP_LOGIN_PASSWORD": login_pass,
        "GSHEET_URL": gsheet_url,
        "GSHEET_WORKSHEET": worksheet_name,
        "GCP_SERVICE_ACCOUNT_JSON": gcp_sa_json,
        "GEMINI_API_KEY": gemini_api_key,
        "GDRIVE_FOLDER_ID": gdrive_folder_id,
    }


CFG = get_app_config()


# =========================
# STYLING
# =========================

st.markdown(
    """
<style>
.block-container { padding-top: 1rem; }
.small-muted { color: #6b7280; font-size: 1rem; }
.card {
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 14px;
    background: #ffffff;
}
.section-title {
    font-size: 1.05rem;
    font-weight: 700;
    margin-bottom: .5rem;
}

/* ===== Login shell / hero ===== */
.login-shell-wrapper hr { display: none !important; }


.login-shell::before {
    display: none !important;
    content: none !important;
}

.login-hero {
    background: rgba(255,255,255,0.90);
    border: 1px solid rgba(148,163,184,0.20);
    border-radius: 18px;
    padding: 14px 14px 10px 14px;
    margin-bottom: 10px;
    box-shadow: none !important;
    backdrop-filter: none !important;
}

.logo-row {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 18px;
    margin-bottom: 8px;
}
.logo-left-wrap,
.logo-right-wrap {
    display: flex;
    align-items: center;
    justify-content: center;
}
.logo-left-wrap {
    width: 108px;   
    height: 86px;
}
.logo-right-wrap {
    width: 96px;
    height: 86px;
}
.logo-left-wrap img {
    max-width: 88px;
    max-height: 72px;
    object-fit: contain;
}
.logo-right-wrap img {
    max-width: 74px;
    max-height: 72px;
    object-fit: contain;
}

.login-title-center {
    text-align: center;
}
.login-title-center h1 {
    margin: 0;
    font-size: 1.95rem;
    line-height: 1.1;
    color: #2b2d42;
    font-weight: 800;
    letter-spacing: 0.2px;
}
.login-title-center .subtitle {
    margin-top: 6px;
    color: #4b5563;
    font-size: 1.02rem;
    font-weight: 500;
}

.login-card-box {
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(148,163,184,0.22);
    border-radius: 18px;
    padding: 14px;
    box-shadow: none !important;
    backdrop-filter: none !important;
}
.login-card-box h3 {
    margin-top: 0.1rem !important;
    margin-bottom: 0.35rem !important;
    font-size: 1.5rem !important;
}
.login-card-box .login-head-note {
    color: #6b7280;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}
.login-card-box [data-testid="stTextInput"] label,
.login-card-box [data-testid="stTextInputRootElement"] label {
    font-weight: 600;
}
.login-card-box [data-testid="stTextInput"] > div > div input {
    border-radius: 10px;
}
.login-card-box [data-testid="stButton"] button {
    border-radius: 10px;
    font-weight: 600;
}

.login-info-box {
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(148,163,184,0.22);
    border-radius: 18px;
    padding: 12px 14px;
    box-shadow: none !important;
    backdrop-filter: none !important;
}

.login-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    background: #eef2ff;
    border: 1px solid #c7d2fe;
    color: #4338ca;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.55rem;
}
.login-paragraph {
    margin-bottom: 0.55rem;
    color: #1f2937;
    line-height: 1.55;
    font-size: 1.2rem;
}
.feature-list {
    display: grid;
    gap: 8px;
    margin-bottom: 0.6rem;
}
.feature-item {
    border: 1px solid #dbeafe;
    background: #f8fbff;
    border-radius: 12px;
    padding: 8px 10px;
}
.feature-title {
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 2px;
    font-size: 1.2rem;
}
.feature-desc {
    color: #475569;
    line-height: 1.45;
    font-size: 1.2rem;
}
.quote-box {
    border: 1px dashed #93c5fd;
    background: #f8fbff;
    border-radius: 12px;
    padding: 9px 10px;
    color: #1e293b;
    line-height: 1.5;
    font-size: 1.2rem;
}

/* Compact spacing on login widgets */
.login-card-box .stTextInput, .login-card-box .stButton {
    margin-bottom: 0.15rem;
}
.login-card-box div[data-testid="stCaptionContainer"] {
    margin-top: -2px;
}

/* Entry form helpers */
.helper-box {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 10px 12px;
    background: #fafafa;
}
.helper-title {
    font-weight: 700;
    margin-bottom: 6px;
    color: #111827;
}
.tiny {
    font-size: 1rem;
    color: #6b7280;
}

@media (max-width: 1100px) {
    .login-title-center h1 { font-size: 1.72rem; }
    .login-title-center .subtitle { font-size: 1.2rem; }
    .logo-left-wrap { width: 94px; height: 78px; }
    .logo-right-wrap { width: 84px; height: 78px; }
    .logo-left-wrap img { max-width: 76px; max-height: 64px; }
    .logo-right-wrap img { max-width: 64px; max-height: 64px; }
}

@media (max-width: 768px) {
    .login-shell { padding: 12px; border-radius: 16px; }
    .login-hero { padding: 12px 10px 8px 10px; }
    .logo-row { gap: 10px; margin-bottom: 6px; }
    .logo-left-wrap, .logo-right-wrap { height: 64px; }
    .logo-left-wrap { width: 78px; }
    .logo-right-wrap { width: 70px; }
    .logo-left-wrap img { max-width: 62px; max-height: 56px; }
    .logo-right-wrap img { max-width: 52px; max-height: 56px; }
    .login-title-center h1 { font-size: 1.36rem; }
    .login-title-center .subtitle { font-size: 1rem; }
    .login-info-box, .login-card-box { border-radius: 14px; }
    .login-paragraph { font-size: 1.2rem; }
}
</style>
    """,
    unsafe_allow_html=True,
)


# =========================
# LOGIN
# =========================

def ensure_auth_state():
    if "authenticated" not in st.session_state:
        st.session_state.authenticated = False
    if "login_username" not in st.session_state:
        st.session_state.login_username = ""
    if "show_fishbone_preview" not in st.session_state:
        st.session_state.show_fishbone_preview = False


def render_login_header_hero():
    html_block = (
        "<div class='login-hero'>"
        "<div class='logo-row'>"
        f"<div class='logo-left-wrap'><img src='{LOGO_HA_URL}' alt='HA Logo'></div>"
        "</div>"
        "<div class='login-title-center'>"
        f"<h1> {html.escape(CFG['APP_TITLE'])}</h1>"
        "<div class='title'><strong>P</strong>rimary <strong>H</strong>ealthcare <strong>O</strong>ccurence/<strong>I</strong>ncident <strong>R</strong>eport: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥</div>"
        "</div>"
        "</div>"
    )
    st.markdown(html_block, unsafe_allow_html=True)


def render_login_info_panel():
    html_block = (
        "<div class='login-info-box'>"
        "<div class='login-badge'>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥ (‡∏™‡∏£‡∏û.) ‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà 1</div>"

        "<div class='login-paragraph'>"
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥ <br>"
        "‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å <br>"
        "‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á <br>"
        "‡πÇ‡∏î‡∏¢‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
        "</div>"

        "<div class='login-paragraph'>"
        "‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥ (‡∏™‡∏£‡∏û.) ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà<br>"
        "<strong>‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.6 ‡∏Ç. ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</strong> ‡πÅ‡∏•‡∏∞ <br>"
        "<strong>‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4.3 ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</strong> ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö<br>"
        "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏≤ (Medication Error)<br> "
        "‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô<br>"
        "‡∏Ç‡πâ‡∏≠ 4.3 (‡∏Ç.4) ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå"
        "</div>"
        "<div class='login-info-box'>"
        "<div class='login-badge'>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô</div>"

        "<div class='feature-list'>"
        "<div class='feature-item'>"
        "<div class='feature-title'>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° (Record with Ease)</div>"
        "<div class='feature-desc'>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</div>"
        "</div>"

        "<div class='feature-item'>"
        "<div class='feature-title'>üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (Local Data Analysis)</div>"
        "<div class='feature-desc'>‡∏°‡∏µ RCA assistant ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br>"
        "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡πà‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Dashboard ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</div>"
        "</div>"

        "<div class='feature-item'>"
        "<div class='feature-title'>üîÑ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Continuous Improvement)</div>"
        "<div class='feature-desc'>‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data-Driven) ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î</div>"
        "</div>"
        "</div>"

        "<div class='quote-box'>"
        "<strong>\"‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏ú‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ\"</strong><br>"
        "‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ ‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á <strong>‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Safety Culture)</strong> ‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á<br>"
        "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
        "</div>"
        "</div>"
    )
    st.markdown(html_block, unsafe_allow_html=True)


def render_login():
    ensure_auth_state()

    st.markdown('<div class="login-shell-wrapper">', unsafe_allow_html=True)
    st.markdown('<div class="login-shell">', unsafe_allow_html=True)

    render_login_header_hero()

    left, right = st.columns([0.9, 1.7], gap="large")

    with left:
        st.markdown('<div class="login-card-box">', unsafe_allow_html=True)
        st.markdown("### üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")
        st.markdown(f"<div class='login-head-note'>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <b>{html.escape(CFG['UNIT_NAME'])}</b></div>", unsafe_allow_html=True)

        username = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", key="login_user_input", placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
        password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", key="login_pass_input", placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")

        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True):
            expected_user = CFG["APP_LOGIN_USERNAME"]
            expected_pass = CFG["APP_LOGIN_PASSWORD"]

            # Dev bypass
            if not expected_user or not expected_pass:
                st.session_state.authenticated = True
                st.session_state.login_username = username or "dev-user"
                st.warning("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ APP_LOGIN_USERNAME / APP_LOGIN_PASSWORD ‡πÉ‡∏ô ENV ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö dev mode")
                st.rerun()

            if username == expected_user and password == expected_pass:
                st.session_state.authenticated = True
                st.session_state.login_username = username
                st.success("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ")
                st.rerun()
            else:
                st.error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

        st.markdown("</div>", unsafe_allow_html=True)

    with right:
        render_login_info_panel()

    st.markdown("</div>", unsafe_allow_html=True)
    st.markdown("</div>", unsafe_allow_html=True)


# =========================
# GOOGLE API (Sheets + Drive)
# =========================

@st.cache_resource(show_spinner=False)
def get_google_credentials():
    sa_json_str = CFG["GCP_SERVICE_ACCOUNT_JSON"]
    if not sa_json_str:
        raise ValueError("‡πÑ‡∏°‡πà‡∏û‡∏ö GCP_SERVICE_ACCOUNT_JSON ‡πÉ‡∏ô Environment Variables")

    try:
        creds_dict = json.loads(sa_json_str)
    except json.JSONDecodeError as e:
        raise ValueError(f"GCP_SERVICE_ACCOUNT_JSON ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {e}")

    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive",
    ]
    creds = Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return creds


@st.cache_resource(show_spinner=False)
def get_gspread_client():
    creds = get_google_credentials()
    return gspread.authorize(creds)


@st.cache_resource(show_spinner=False)
def get_drive_service():
    creds = get_google_credentials()
    return build("drive", "v3", credentials=creds, cache_discovery=False)


# =========================
# GOOGLE SHEETS
# =========================

@st.cache_resource(show_spinner=False)
def get_worksheet():
    gsheet_url = CFG["GSHEET_URL"]
    worksheet_name = CFG["GSHEET_WORKSHEET"]

    if not gsheet_url:
        raise ValueError("‡πÑ‡∏°‡πà‡∏û‡∏ö GSHEET_URL ‡πÉ‡∏ô Environment Variables")

    client = get_gspread_client()
    sh = client.open_by_url(gsheet_url)

    try:
        ws = sh.worksheet(worksheet_name)
    except gspread.WorksheetNotFound:
        ws = sh.add_worksheet(title=worksheet_name, rows=1000, cols=80)

    header = ws.row_values(1)
    if not header:
        ws.append_row(SHEET_COLUMNS, value_input_option="USER_ENTERED")
    else:
        missing_cols = [c for c in SHEET_COLUMNS if c not in header]
        if missing_cols:
            all_vals = ws.get_all_values()
            if all_vals:
                df_old = pd.DataFrame(all_vals[1:], columns=all_vals[0])
            else:
                df_old = pd.DataFrame(columns=[])

            for col in SHEET_COLUMNS:
                if col not in df_old.columns:
                    df_old[col] = ""

            df_old = df_old[SHEET_COLUMNS]

            ws.clear()
            ws.append_row(SHEET_COLUMNS, value_input_option="USER_ENTERED")
            if not df_old.empty:
                ws.append_rows(
                    df_old.fillna("").astype(str).values.tolist(),
                    value_input_option="USER_ENTERED",
                )

    return ws


def append_record_to_sheet(record: Dict[str, Any]) -> None:
    ws = get_worksheet()
    row = []
    for col in SHEET_COLUMNS:
        val = record.get(col, "")
        row.append("" if val is None else str(val))
    ws.append_row(row, value_input_option="USER_ENTERED")


@st.cache_data(show_spinner=False, ttl=30)
def load_sheet_df() -> pd.DataFrame:
    ws = get_worksheet()
    records = ws.get_all_records()
    if not records:
        return pd.DataFrame(columns=SHEET_COLUMNS)

    df = pd.DataFrame(records)
    for c in SHEET_COLUMNS:
        if c not in df.columns:
            df[c] = ""

    # normalize legacy rows
    if "incident_group" not in df.columns:
        df["incident_group"] = ""
    if "event_code" not in df.columns:
        df["event_code"] = ""
    if "event_topic" not in df.columns:
        df["event_topic"] = ""
    if "event_display" not in df.columns:
        df["event_display"] = ""
    if "severity_scheme" not in df.columns:
        df["severity_scheme"] = ""

    # ‡πÄ‡∏ï‡∏¥‡∏° fallback ‡∏à‡∏≤‡∏Å process_step ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤
    df["event_code"] = df["event_code"].astype(str)
    df["event_topic"] = df["event_topic"].astype(str)
    df["event_display"] = df["event_display"].astype(str)
    df["process_step"] = df["process_step"].astype(str)

    mask_no_code = df["event_code"].str.strip().eq("")
    df.loc[mask_no_code, "event_code"] = df.loc[mask_no_code, "process_step"]

    mask_no_disp = df["event_display"].str.strip().eq("")
    df.loc[mask_no_disp, "event_display"] = df.loc[mask_no_disp, "process_step"]

    return df[SHEET_COLUMNS]


# =========================
# GOOGLE DRIVE UPLOAD (RCA IMAGE)
# =========================

def upload_rca_image_to_drive(uploaded_file: Any, record_id: str) -> Dict[str, str]:
    if uploaded_file is None:
        return {"file_id": "", "file_name": "", "file_url": ""}

    folder_id = str(CFG.get("GDRIVE_FOLDER_ID", "") or "").strip()
    if not folder_id:
        raise ValueError("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GDRIVE_FOLDER_ID ‡πÉ‡∏ô Environment Variables")

    drive = get_drive_service()

    original_name = getattr(uploaded_file, "name", "attachment.png")
    mime_type = getattr(uploaded_file, "type", None) or "application/octet-stream"
    safe_name = f"{record_id}_{original_name}"

    file_metadata = {"name": safe_name, "parents": [folder_id]}

    media = MediaIoBaseUpload(
        BytesIO(uploaded_file.getvalue()),
        mimetype=mime_type,
        resumable=False,
    )

    created = drive.files().create(
        body=file_metadata,
        media_body=media,
        fields="id,name",
        supportsAllDrives=True,
    ).execute()

    file_id = created.get("id", "")
    file_name = created.get("name", safe_name)
    file_url = f"https://drive.google.com/file/d/{file_id}/view" if file_id else ""

    return {"file_id": file_id, "file_name": file_name, "file_url": file_url}


# =========================
# HELPERS: EVENT CODES / SEVERITY
# =========================

def event_code_options_for_group(group_name: str) -> List[str]:
    items = EVENT_CODE_MAP.get(group_name, [])
    opts = [f"{code} | {topic}" for code, topic in items]
    opts.append("‡∏≠‡∏∑‡πà‡∏ô ‡πÜ | ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏≠‡∏á")
    return opts


def parse_event_code_option(selected: str) -> Tuple[str, str]:
    s = str(selected or "").strip()
    if not s:
        return "", ""
    if s.startswith("‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"):
        return "OTHER", "‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏≠‡∏á"
    if "|" in s:
        code, topic = s.split("|", 1)
        return code.strip(), topic.strip()
    return s.strip(), ""


def current_severity_scheme(group_name: str) -> str:
    return "1-5" if group_name == "People Safety" else "A-I"


def severity_options_for_group(group_name: str) -> List[str]:
    return SEVERITY_OPTIONS_PEOPLE if current_severity_scheme(group_name) == "1-5" else SEVERITY_OPTIONS_AI


def severity_description(level: str, group_name: str) -> str:
    if current_severity_scheme(group_name) == "1-5":
        return SEVERITY_DESC_PEOPLE.get(str(level), "")
    return SEVERITY_DESC_AI.get(str(level), "")


def render_severity_guide(group_name: str):
    scheme = current_severity_scheme(group_name)
    with st.expander(f"üìò ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ({scheme})", expanded=False):
        if scheme == "1-5":
            data = [{"‡∏£‡∏∞‡∏î‡∏±‡∏ö": k, "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î": v} for k, v in SEVERITY_DESC_PEOPLE.items()]
        else:
            data = [{"‡∏£‡∏∞‡∏î‡∏±‡∏ö": k, "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î": v} for k, v in SEVERITY_DESC_AI.items()]
        st.dataframe(pd.DataFrame(data), use_container_width=True, hide_index=True)


# =========================
# DOCX EXPORT (BEFORE SAVE)
# =========================

def build_docx_report_bytes(uploaded_rca_image: Optional[Any] = None) -> bytes:
    doc = Document()

    doc.add_heading("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå / RCA (‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", level=1)
    doc.add_paragraph(f"‡∏£‡∏∞‡∏ö‡∏ö: {CFG.get('APP_TITLE', '-')}")
    doc.add_paragraph(f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

    # Resolve form values
    event_date_val = st.session_state.get("form_event_date", "")
    event_time_val = st.session_state.get("form_event_time", "")
    group_name = st.session_state.get("form_incident_group", "")
    unit_name = st.session_state.get("form_service_unit", "")
    sev = st.session_state.get("form_severity", "")

    if isinstance(event_date_val, date):
        event_date_text = event_date_val.isoformat()
    else:
        event_date_text = str(event_date_val)

    if isinstance(event_time_val, time):
        event_time_text = event_time_val.strftime("%H:%M")
    else:
        event_time_text = str(event_time_val)

    code_option = st.session_state.get("form_event_code_option", "")
    code, topic = parse_event_code_option(code_option)
    if code == "OTHER":
        code = str(st.session_state.get("form_event_code_other_code", "") or "").strip()
        topic = str(st.session_state.get("form_event_code_other_topic", "") or "").strip()

    doc.add_heading("1) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", level=2)
    t = doc.add_table(rows=0, cols=2)
    t.style = "Table Grid"

    def add_row(k: str, v: str):
        row = t.add_row().cells
        row[0].text = str(k)
        row[1].text = str(v or "")

    add_row("‡∏´‡∏ô‡πà‡∏ß‡∏¢", unit_name)
    add_row("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏", event_date_text)
    add_row("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏", event_time_text)
    add_row("‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", group_name)
    add_row("‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", code)
    add_row("‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", topic)
    add_row("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á", f"{sev} ({current_severity_scheme(group_name)})")
    sev_desc = severity_description(sev, group_name)
    if sev_desc:
        add_row("‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö", sev_desc)

    doc.add_heading("2) ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", level=2)
    doc.add_paragraph(st.session_state.get("form_incident_detail", "") or "-")

    doc.add_heading("3) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)", level=2)
    doc.add_paragraph("3.1 ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå")
    doc.add_paragraph(st.session_state.get("form_timeline_text", "") or "-")

    doc.add_paragraph("3.2 ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô")
    doc.add_paragraph(st.session_state.get("form_initial_correction", "") or "-")

    doc.add_paragraph("3.3 RCA (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)")
    doc.add_paragraph(st.session_state.get("form_rca_text", "") or "-")

    doc.add_paragraph("3.4 ‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤")
    doc.add_paragraph(st.session_state.get("form_development_plan", "") or "-")

    analysis = st.session_state.get("rca_analysis_json") or {}
    plan = st.session_state.get("rca_plan_json") or {}

    if analysis:
        doc.add_heading("4) ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå RCA ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", level=2)

        doc.add_paragraph("4.1 ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
        doc.add_paragraph(str(analysis.get("event_summary", "-")))

        timeline = analysis.get("timeline", []) or []
        doc.add_paragraph("4.2 ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
        if timeline:
            for item in timeline:
                doc.add_paragraph(f"- {item}")
        else:
            doc.add_paragraph("-")

        fishbone = analysis.get("fishbone", {}) or {}
        doc.add_paragraph("4.3 Fishbone (‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)")
        effect = fishbone.get("effect", "")
        if effect:
            doc.add_paragraph(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå/‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: {effect}")
        for cat in (fishbone.get("categories", []) or []):
            label = str(cat.get("label", "") or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
            doc.add_paragraph(f"‡∏´‡∏°‡∏ß‡∏î: {label}")
            for it in (cat.get("items", []) or []):
                doc.add_paragraph(f"  - {it}")

        whys = analysis.get("five_whys", []) or []
        doc.add_paragraph("4.4 5 Whys")
        if whys:
            for w in whys:
                doc.add_paragraph(f"- {w}")
        else:
            doc.add_paragraph("-")

        swiss = analysis.get("swiss_cheese", []) or []
        doc.add_paragraph("4.5 Swiss Cheese")
        if swiss:
            for row in swiss:
                line = (
                    f"[{row.get('layer','')}] "
                    f"type={row.get('type','')} | "
                    f"hole={row.get('hole','')} | "
                    f"prevention={row.get('prevention','')}"
                )
                doc.add_paragraph(f"- {line}")
        else:
            doc.add_paragraph("-")

        factors = analysis.get("contributing_factors", []) or []
        doc.add_paragraph("4.6 ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏≠‡∏∑‡πâ‡∏≠/‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏£‡πà‡∏ß‡∏°")
        if factors:
            for f in factors:
                doc.add_paragraph(f"- {f}")
        else:
            doc.add_paragraph("-")

    if plan:
        doc.add_heading("5) ‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ / PDSA ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", level=2)

        pdsa = plan.get("pdsa", {}) or {}
        for key_th, key_en in [("Plan", "plan"), ("Do", "do"), ("Study", "study"), ("Act", "act")]:
            doc.add_paragraph(f"PDSA - {key_th}")
            items = pdsa.get(key_en, []) or []
            if items:
                for it in items:
                    doc.add_paragraph(f"- {it}")
            else:
                doc.add_paragraph("-")

        ap = plan.get("action_plan", []) or []
        doc.add_paragraph("Action Plan")
        if ap:
            for i, row in enumerate(ap, 1):
                line = (
                    f"{i}) {row.get('measure','')} | "
                    f"‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: {row.get('owner','')} | "
                    f"‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à: {row.get('due','')} | "
                    f"KPI: {row.get('kpi','')}"
                )
                doc.add_paragraph(line)
        else:
            doc.add_paragraph("-")

        ideas = plan.get("initiative_ideas", {}) or {}
        doc.add_paragraph("Initiative Ideas - Quick Wins (0‚Äì30 ‡∏ß‡∏±‡∏ô)")
        for x in ideas.get("quick_wins_0_30_days", []) or []:
            doc.add_paragraph(f"- {x}")

        doc.add_paragraph("Initiative Ideas - ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏•‡∏≤‡∏á (1‚Äì3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)")
        for x in ideas.get("mid_term_1_3_months", []) or []:
            doc.add_paragraph(f"- {x}")

        doc.add_paragraph("Initiative Ideas - ‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (3‚Äì12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)")
        for x in ideas.get("long_term_3_12_months", []) or []:
            doc.add_paragraph(f"- {x}")

        recs = plan.get("conclusion_recommendations", []) or []
        doc.add_paragraph("Conclusion & Recommendations")
        for i, x in enumerate(recs, 1):
            doc.add_paragraph(f"{i}. {x}")

        next72 = plan.get("next_72_hours", []) or []
        doc.add_paragraph("‡∏Å‡πâ‡∏≤‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)")
        for x in next72:
            doc.add_paragraph(f"- {x}")

    if uploaded_rca_image is not None:
        try:
            doc.add_heading("6) ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö", level=2)
            img_bytes = uploaded_rca_image.getvalue()
            doc.add_paragraph(f"‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: {getattr(uploaded_rca_image, 'name', '-')}")
            doc.add_picture(BytesIO(img_bytes), width=Inches(6.2))
        except Exception as e:
            doc.add_paragraph(f"(‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ‡∏•‡∏á DOCX ‡πÑ‡∏î‡πâ: {e})")

    out = BytesIO()
    doc.save(out)
    out.seek(0)
    return out.getvalue()


# =========================
# GEMINI / RCA ASSISTANT
# =========================

def call_gemini_json(
    prompt: str,
    api_key: str,
    image_file: Optional[Any] = None,
    timeout_sec: int = 60,
) -> Dict[str, Any]:
    if not api_key:
        raise ValueError("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GEMINI_API_KEY ‡πÉ‡∏ô Environment Variables")

    url = (
        "https://generativelanguage.googleapis.com/v1beta/models/"
        f"gemini-2.5-flash:generateContent?key={api_key}"
    )

    parts: List[Dict[str, Any]] = [{"text": prompt}]

    if image_file is not None:
        try:
            import base64
            img_bytes = image_file.getvalue()
            mime_type = getattr(image_file, "type", None) or "image/png"
            parts.append(
                {
                    "inline_data": {
                        "mime_type": mime_type,
                        "data": base64.b64encode(img_bytes).decode("utf-8"),
                    }
                }
            )
        except Exception:
            pass

    payload = {
        "contents": [{"parts": parts}],
        "generationConfig": {"responseMimeType": "application/json"},
        "safetySettings": [
            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
        ],
    }

    resp = requests.post(url, json=payload, timeout=timeout_sec)
    try:
        data = resp.json()
    except Exception:
        raise RuntimeError(f"Gemini API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (HTTP {resp.status_code})")

    if not resp.ok:
        err_msg = data.get("error", {}).get("message", f"Gemini API error ({resp.status_code})")
        raise RuntimeError(err_msg)

    text = (
        data.get("candidates", [{}])[0]
        .get("content", {})
        .get("parts", [{}])[0]
        .get("text", "")
    )

    if not text:
        raise RuntimeError("Gemini ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤")

    cleaned = re.sub(r"^```(?:json)?\s*", "", text.strip(), flags=re.I)
    cleaned = re.sub(r"\s*```$", "", cleaned.strip())

    try:
        return json.loads(cleaned)
    except json.JSONDecodeError as e:
        raise RuntimeError(f"Gemini ‡∏™‡πà‡∏á JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {e}\n\nRaw response:\n{cleaned[:2000]}")


def build_analysis_prompt(incident_text: str) -> str:
    return f"""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞ RCA ‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•
‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ markdown ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å JSON)

‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:
\"\"\"{incident_text}\"\"\"

‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:
{{
  "event_summary": "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö 2-4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î",
  "timeline": [
    "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1 ...",
    "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2 ..."
  ],
  "fishbone": {{
    "effect": "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏±‡πâ‡∏ô‡πÜ",
    "categories": [
      {{
        "label": "‡∏Ñ‡∏ô",
        "items": ["...", "..."]
      }},
      {{
        "label": "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£",
        "items": ["...", "..."]
      }}
    ]
  }},
  "five_whys": [
    "‡∏ó‡∏≥‡πÑ‡∏° 1: ...",
    "‡∏ó‡∏≥‡πÑ‡∏° 2: ...",
    "‡∏ó‡∏≥‡πÑ‡∏° 3: ...",
    "‡∏ó‡∏≥‡πÑ‡∏° 4: ...",
    "‡∏ó‡∏≥‡πÑ‡∏° 5: ... (‡∏£‡∏≤‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏)"
  ],
  "swiss_cheese": [
    {{
      "layer": "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£",
      "type": "latent/active",
      "hole": "‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà",
      "prevention": "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô"
    }}
  ],
  "contributing_factors": [
    "‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏≠‡∏∑‡πâ‡∏≠ 1",
    "‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏≠‡∏∑‡πâ‡∏≠ 2"
  ]
}}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
- fishbone.categories ‡∏°‡∏µ‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏´‡∏°‡∏ß‡∏î
- ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î items ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ç‡πâ‡∏≠
- swiss_cheese ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡πÅ‡∏ñ‡∏ß
- five_whys ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ç‡πâ‡∏≠
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô
    """.strip()


def build_plan_prompt(incident_text: str, analysis_json: Dict[str, Any]) -> str:
    analysis_text = json.dumps(analysis_json, ensure_ascii=False)
    return f"""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•
‡∏à‡∏≤‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå RCA ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:
\"\"\"{incident_text}\"\"\"

‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:
{analysis_text}

‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON:
{{
  "pdsa": {{
    "plan": ["...","..."],
    "do": ["...","..."],
    "study": ["...","..."],
    "act": ["...","..."]
  }},
  "action_plan": [
    {{
      "measure": "‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£",
      "owner": "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
      "due": "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à",
      "kpi": "‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î",
      "risk_control": "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏•‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"
    }}
  ],
  "initiative_ideas": {{
    "quick_wins_0_30_days": ["...","..."],
    "mid_term_1_3_months": ["...","..."],
    "long_term_3_12_months": ["...","..."]
  }},
  "conclusion_recommendations": [
    "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡πâ‡∏≠ 1",
    "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡πâ‡∏≠ 2",
    "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡πâ‡∏≠ 3",
    "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡πâ‡∏≠ 4",
    "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡πâ‡∏≠ 5"
  ],
  "next_72_hours": [
    "‡∏Å‡πâ‡∏≤‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏Ç‡πâ‡∏≠ 1",
    "‡∏Å‡πâ‡∏≤‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏Ç‡πâ‡∏≠ 2"
  ]
}}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
- action_plan 3-8 ‡πÅ‡∏ñ‡∏ß
- recommendation ‡πÉ‡∏´‡πâ 5 ‡∏Ç‡πâ‡∏≠‡∏û‡∏≠‡∏î‡∏µ
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    """.strip()


# =========================
# RENDER ANALYSIS / PLAN
# =========================

def render_analysis_result(analysis: Dict[str, Any]):
    st.subheader("üîé ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå RCA")

    st.markdown("### 1) ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
    st.write(analysis.get("event_summary", "-"))

    st.markdown("### 2) ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
    timeline = analysis.get("timeline", []) or []
    if timeline:
        for i, item in enumerate(timeline, 1):
            st.markdown(f"- **{i}.** {item}")
    else:
        st.write("-")

    st.markdown("### 3) ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏Å‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≤ (Ishikawa) ‚Äî ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")
    fishbone = analysis.get("fishbone", {}) or {}
    effect = fishbone.get("effect", "") or analysis.get("event_summary", "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå / ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå")
    categories = fishbone.get("categories", []) or []

    st.markdown("**‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå / ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**")
    st.write(effect if str(effect).strip() else "-")

    if categories:
        for idx, c in enumerate(categories, 1):
            label = str(c.get("label", "") or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏").strip()
            items = [str(x).strip() for x in (c.get("items", []) or []) if str(x).strip()]
            st.markdown(f"**{idx}) {label}**")
            if items:
                for item in items:
                    st.markdown(f"- {item}")
            else:
                st.markdown("- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")
    else:
        st.write("-")

    st.markdown("### 4) ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏≥‡πÑ‡∏°-‡∏ó‡∏≥‡πÑ‡∏° (5 Whys)")
    whys = analysis.get("five_whys", []) or []
    if whys:
        for i, w in enumerate(whys, 1):
            st.markdown(f"{i}. {w}")
    else:
        st.write("-")

    st.markdown("### 5) ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏ß‡∏¥‡∏™‡∏ä‡∏µ‡∏™")
    swiss = analysis.get("swiss_cheese", []) or []
    if swiss:
        df_swiss = pd.DataFrame(swiss).rename(
            columns={
                "layer": "‡∏ä‡∏±‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
                "type": "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
                "hole": "‡∏£‡∏π (‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà)",
                "prevention": "‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
            }
        )
        st.dataframe(df_swiss, use_container_width=True, hide_index=True)
    else:
        st.write("-")

    factors = analysis.get("contributing_factors", []) or []
    if factors:
        st.markdown("### 6) ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏≠‡∏∑‡πâ‡∏≠/‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏£‡πà‡∏ß‡∏°")
        for f in factors:
            st.markdown(f"- {f}")


def render_plan_result(plan: Dict[str, Any]):
    st.subheader("üéØ ‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ / PDSA")

    pdsa = plan.get("pdsa", {}) or {}
    pdsa_rows = [
        ["‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Plan)", "\n".join([f"- {x}" for x in (pdsa.get("plan", []) or [])])],
        ["‡∏ó‡∏≥ (Do)", "\n".join([f"- {x}" for x in (pdsa.get("do", []) or [])])],
        ["‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Study)", "\n".join([f"- {x}" for x in (pdsa.get("study", []) or [])])],
        ["‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Act)", "\n".join([f"- {x}" for x in (pdsa.get("act", []) or [])])],
    ]
    st.markdown("### 1) PDSA")
    st.dataframe(
        pd.DataFrame(pdsa_rows, columns=["‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"]),
        use_container_width=True,
        hide_index=True,
    )

    st.markdown("### 2) Action Plan")
    ap = plan.get("action_plan", []) or []
    if ap:
        df_ap = pd.DataFrame(ap).rename(
            columns={
                "measure": "‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£",
                "owner": "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
                "due": "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à",
                "kpi": "KPI(‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)",
                "risk_control": "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏•‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á",
            }
        )
        st.dataframe(df_ap, use_container_width=True, hide_index=True)
    else:
        st.write("-")

    st.markdown("### 3) Initiative Ideas")
    ideas = plan.get("initiative_ideas", {}) or {}
    col1, col2, col3 = st.columns(3)
    with col1:
        st.markdown("**Quick Wins (0‚Äì30 ‡∏ß‡∏±‡∏ô)**")
        for x in ideas.get("quick_wins_0_30_days", []) or []:
            st.markdown(f"- {x}")
    with col2:
        st.markdown("**‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏•‡∏≤‡∏á (1‚Äì3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)**")
        for x in ideas.get("mid_term_1_3_months", []) or []:
            st.markdown(f"- {x}")
    with col3:
        st.markdown("**‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (3‚Äì12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)**")
        for x in ideas.get("long_term_3_12_months", []) or []:
            st.markdown(f"- {x}")

    st.markdown("### 4) Conclusion & Recommendations")
    recs = plan.get("conclusion_recommendations", []) or []
    if recs:
        for i, x in enumerate(recs, 1):
            st.markdown(f"{i}. {x}")
    else:
        st.write("-")

    st.markdown("**‡∏Å‡πâ‡∏≤‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)**")
    next72 = plan.get("next_72_hours", []) or []
    if next72:
        for x in next72:
            st.markdown(f"- {x}")
    else:
        st.write("-")


# =========================
# FORM / SAVE
# =========================

def init_form_state_defaults():
    defaults = {
        "form_service_unit": UNIT_OPTIONS[0],
        "form_event_date": date.today(),
        "form_event_time": datetime.now().time().replace(second=0, microsecond=0),

        "form_incident_group": INCIDENT_GROUP_OPTIONS[0],
        "form_event_code_option": "",
        "form_event_code_other_code": "",
        "form_event_code_other_topic": "",

        "form_severity": "A",
        "form_drug_name": "",  # ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ compatibility (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°)
        "form_incident_detail": "",
        "form_timeline_text": "",
        "form_initial_correction": "",
        "form_rca_text": "",
        "form_development_plan": "",
        "rca_analysis_json": None,
        "rca_plan_json": None,
    }
    for k, v in defaults.items():
        if k not in st.session_state:
            st.session_state[k] = v

    # ensure event code option default matches group
    group_name = st.session_state.get("form_incident_group", INCIDENT_GROUP_OPTIONS[0])
    opts = event_code_options_for_group(group_name)
    if st.session_state.get("form_event_code_option", "") not in opts:
        st.session_state["form_event_code_option"] = opts[0] if opts else ""

    # ensure severity default matches scheme
    scheme = current_severity_scheme(group_name)
    sev = str(st.session_state.get("form_severity", ""))
    if scheme == "1-5" and sev not in SEVERITY_OPTIONS_PEOPLE:
        st.session_state["form_severity"] = "1"
    elif scheme == "A-I" and sev not in SEVERITY_OPTIONS_AI:
        st.session_state["form_severity"] = "A"


def validate_required_form() -> Tuple[bool, List[str]]:
    errs: List[str] = []

    if not str(st.session_state.get("form_service_unit", "")).strip():
        errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢")

    group_name = str(st.session_state.get("form_incident_group", "")).strip()
    if not group_name:
        errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")

    selected_option = str(st.session_state.get("form_event_code_option", "")).strip()
    code, _topic = parse_event_code_option(selected_option)
    if not selected_option:
        errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
    elif code == "OTHER":
        other_code = str(st.session_state.get("form_event_code_other_code", "")).strip()
        other_topic = str(st.session_state.get("form_event_code_other_topic", "")).strip()
        if not other_code:
            errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)")
        if not other_topic:
            errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)")

    if not str(st.session_state.get("form_incident_detail", "")).strip():
        errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")

    sev = str(st.session_state.get("form_severity", "")).strip()
    if not sev:
        errs.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á")

    return (len(errs) == 0, errs)


def create_record_from_form(
    uploaded_rca_image: Optional[Any],
    rca_image_drive_url: str = "",
) -> Dict[str, Any]:
    now = datetime.now()
    event_date_val = st.session_state.get("form_event_date")
    event_time_val = st.session_state.get("form_event_time")

    if isinstance(event_date_val, datetime):
        event_date_str = event_date_val.date().isoformat()
    elif isinstance(event_date_val, date):
        event_date_str = event_date_val.isoformat()
    else:
        event_date_str = str(event_date_val)

    if isinstance(event_time_val, datetime):
        event_time_str = event_time_val.strftime("%H:%M")
    elif isinstance(event_time_val, time):
        event_time_str = event_time_val.strftime("%H:%M")
    else:
        event_time_str = str(event_time_val)

    group_name = st.session_state.get("form_incident_group", "")
    selected_option = st.session_state.get("form_event_code_option", "")
    event_code, event_topic = parse_event_code_option(selected_option)

    if event_code == "OTHER":
        event_code = str(st.session_state.get("form_event_code_other_code", "")).strip()
        event_topic = str(st.session_state.get("form_event_code_other_topic", "")).strip()

    event_display = f"{event_code} | {event_topic}".strip(" |")
    sev_scheme = current_severity_scheme(group_name)

    record = {
        "record_id": now.strftime("%Y%m%d%H%M%S%f"),
        "unit_name": st.session_state.get("form_service_unit", "").strip(),  # ‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‚Äù ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        "app_title": CFG["APP_TITLE"],

        "event_date": event_date_str,
        "event_time": event_time_str,

        # compatibility fields
        "process_step": event_code,
        "drug_name": "",

        "severity_level": st.session_state.get("form_severity", ""),
        "incident_detail": st.session_state.get("form_incident_detail", "").strip(),
        "timeline_text": st.session_state.get("form_timeline_text", "").strip(),
        "initial_correction": st.session_state.get("form_initial_correction", "").strip(),
        "rca_text": st.session_state.get("form_rca_text", "").strip(),
        "rca_image_filename": getattr(uploaded_rca_image, "name", "") if uploaded_rca_image else "",
        "rca_image_drive_url": (rca_image_drive_url or "").strip(),
        "development_plan": st.session_state.get("form_development_plan", "").strip(),
        "created_at": now.isoformat(timespec="seconds"),
        "created_by": st.session_state.get("login_username", ""),

        # new fields
        "incident_group": group_name,
        "event_code": event_code,
        "event_topic": event_topic,
        "severity_scheme": sev_scheme,
        "event_display": event_display,
    }
    return record


def request_form_reset_after_save():
    st.session_state["_reset_form_after_save"] = True
    st.session_state["_save_success_message"] = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ"


def apply_pending_form_reset():
    if st.session_state.get("_reset_form_after_save", False):
        st.session_state["form_service_unit"] = UNIT_OPTIONS[0]
        st.session_state["form_event_date"] = date.today()
        st.session_state["form_event_time"] = datetime.now().time().replace(second=0, microsecond=0)
        st.session_state["form_incident_group"] = INCIDENT_GROUP_OPTIONS[0]

        first_opts = event_code_options_for_group(INCIDENT_GROUP_OPTIONS[0])
        st.session_state["form_event_code_option"] = first_opts[0] if first_opts else ""
        st.session_state["form_event_code_other_code"] = ""
        st.session_state["form_event_code_other_topic"] = ""

        st.session_state["form_severity"] = "A"
        st.session_state["form_drug_name"] = ""
        st.session_state["form_incident_detail"] = ""
        st.session_state["form_timeline_text"] = ""
        st.session_state["form_initial_correction"] = ""
        st.session_state["form_rca_text"] = ""
        st.session_state["form_development_plan"] = ""
        st.session_state["rca_analysis_json"] = None
        st.session_state["rca_plan_json"] = None
        st.session_state["show_fishbone_preview"] = False

        st.session_state.pop("form_rca_image", None)

        st.session_state["_reset_form_after_save"] = False


def render_event_selection_block():
    st.markdown("### ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")

    # ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÉ‡∏ä‡πâ radio ‡πÅ‡∏ö‡∏ö horizontal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°)
    prev_group = st.session_state.get("form_incident_group", INCIDENT_GROUP_OPTIONS[0])
    st.radio(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£",
        options=INCIDENT_GROUP_OPTIONS,
        horizontal=True,
        key="form_incident_group",
    )
    curr_group = st.session_state.get("form_incident_group", INCIDENT_GROUP_OPTIONS[0])

    # ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ reset ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ + severity ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞
    if curr_group != prev_group:
        opts = event_code_options_for_group(curr_group)
        st.session_state["form_event_code_option"] = opts[0] if opts else ""
        st.session_state["form_event_code_other_code"] = ""
        st.session_state["form_event_code_other_topic"] = ""

        if current_severity_scheme(curr_group) == "1-5":
            st.session_state["form_severity"] = "1"
        else:
            st.session_state["form_severity"] = "A"

    opts = event_code_options_for_group(curr_group)
    if st.session_state.get("form_event_code_option") not in opts:
        st.session_state["form_event_code_option"] = opts[0] if opts else ""

    st.selectbox(
        "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ)",
        options=opts,
        key="form_event_code_option",
        help="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô CPM201, CPP101, GOI102 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô",
    )

    selected_opt = st.session_state.get("form_event_code_option", "")
    code, topic = parse_event_code_option(selected_opt)

    if code == "OTHER":
        c1, c2 = st.columns([1, 2.2])
        with c1:
            st.text_input("‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)", key="form_event_code_other_code", placeholder="‡πÄ‡∏ä‡πà‡∏ô XYZ999")
        with c2:
            st.text_input("‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)", key="form_event_code_other_topic", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
    else:
        st.markdown(
            f"<div class='helper-box'><div class='helper-title'>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>"
            f"<div><b>{html.escape(code)}</b> ‚Äî {html.escape(topic)}</div></div>",
            unsafe_allow_html=True,
        )


def render_entry_tab():
    init_form_state_defaults()
    apply_pending_form_reset()

    if st.session_state.get("_save_success_message"):
        st.success(st.session_state.pop("_save_success_message"))

    st.markdown("## üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

    left, right = st.columns([1.18, 1], gap="large")

    uploaded_rca_image = None

    with left:
        st.markdown("### ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")

        # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‚Äù ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
        st.selectbox("‡∏´‡∏ô‡πà‡∏ß‡∏¢", UNIT_OPTIONS, key="form_service_unit")

        # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤
        c1, c2 = st.columns(2)
        with c1:
            st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏", key="form_event_date")
        with c2:
            st.time_input("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏", key="form_event_time")

        # ‡∏Å‡∏•‡∏∏‡πà‡∏° + ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
        render_event_selection_block()

        # ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (dynamic)
        group_name = st.session_state.get("form_incident_group", INCIDENT_GROUP_OPTIONS[0])
        sev_options = severity_options_for_group(group_name)
        if st.session_state.get("form_severity") not in sev_options:
            st.session_state["form_severity"] = sev_options[0]

        st.selectbox(
            f"‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ({current_severity_scheme(group_name)})",
            sev_options,
            key="form_severity",
        )

        sev_desc = severity_description(st.session_state.get("form_severity", ""), group_name)
        if sev_desc:
            st.info(f"**‡∏£‡∏∞‡∏î‡∏±‡∏ö {st.session_state.get('form_severity','')}**: {sev_desc}")

        render_severity_guide(group_name)

        # ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
        st.text_area("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", height=140, key="form_incident_detail")

        # ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢ uploader ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ label
        uploaded_rca_image = st.file_uploader(
            "‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö(‡∏´‡∏≤‡∏Å‡∏°‡∏µ)",
            type=["png", "jpg", "jpeg", "webp"],
            key="form_rca_image",
            help="‡∏´‡∏≤‡∏Å‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï",
        )

        if uploaded_rca_image is not None:
            st.image(
                uploaded_rca_image,
                caption=f"‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö: {uploaded_rca_image.name}",
                use_container_width=True,
            )

        st.markdown("---")
        st.markdown("### ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)")
        st.text_area("1) ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå", height=120, key="form_timeline_text")
        st.text_area("2) ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", height=100, key="form_initial_correction")
        st.text_area("3) RCA (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)", height=180, key="form_rca_text")
        st.text_area("4) ‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤", height=140, key="form_development_plan")

        st.markdown("---")

        try:
            docx_bytes = build_docx_report_bytes(uploaded_rca_image=uploaded_rca_image)
            st.download_button(
                "üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô DOCX (‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)",
                data=docx_bytes,
                file_name=f"RCA_Report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                use_container_width=True,
            )
        except Exception as e:
            st.caption(f"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á DOCX ‡πÑ‡∏î‡πâ: {e}")

        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", type="primary", use_container_width=True):
            ok, errs = validate_required_form()
            if not ok:
                for e in errs:
                    st.error(e)
            else:
                try:
                    record = create_record_from_form(uploaded_rca_image=uploaded_rca_image)

                    if uploaded_rca_image is not None:
                        drive_meta = upload_rca_image_to_drive(
                            uploaded_rca_image,
                            record_id=record["record_id"],
                        )
                        record["rca_image_filename"] = drive_meta.get("file_name", "") or getattr(uploaded_rca_image, "name", "")
                        record["rca_image_drive_url"] = drive_meta.get("file_url", "") or ""

                    append_record_to_sheet(record)

                    try:
                        load_sheet_df.clear()
                    except Exception:
                        pass

                    request_form_reset_after_save()
                    st.rerun()

                except Exception as e:
                    st.exception(e)

    with right:
        st.markdown("### üß∏ RCA Assistant")
        st.caption("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

        st.info(
            "‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏õ‡∏∏‡πà‡∏° RCA Assistant ‡∏à‡∏∞ **‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets** ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n"
            "‚Üí ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**"
        )

        if st.button("üß∏ RCA Assistant", use_container_width=True):
            incident_text = st.session_state.get("form_incident_detail", "").strip()
            if not incident_text:
                st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô")
            else:
                try:
                    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå RCA..."):
                        analysis = call_gemini_json(
                            prompt=build_analysis_prompt(incident_text),
                            api_key=CFG["GEMINI_API_KEY"],
                            image_file=uploaded_rca_image,  # ‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI ‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                            timeout_sec=90,
                        )
                        plan = call_gemini_json(
                            prompt=build_plan_prompt(incident_text, analysis),
                            api_key=CFG["GEMINI_API_KEY"],
                            timeout_sec=90,
                        )

                        st.session_state.rca_analysis_json = analysis
                        st.session_state.rca_plan_json = plan

                    st.success("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ")
                except Exception as e:
                    st.error(f"RCA Assistant error: {e}")

        analysis = st.session_state.get("rca_analysis_json")
        plan = st.session_state.get("rca_plan_json")

        if analysis:
            render_analysis_result(analysis)

        if plan:
            st.markdown("---")
            render_plan_result(plan)


# =========================
# HISTORY TAB
# =========================

def parse_event_datetime_columns(df: pd.DataFrame) -> pd.DataFrame:
    out = df.copy()

    out["event_date"] = out.get("event_date", "").astype(str).str.strip()
    out["event_time"] = out.get("event_time", "").astype(str).str.strip()

    out["_event_date_dt"] = pd.to_datetime(out["event_date"], errors="coerce")
    out["_event_datetime"] = pd.to_datetime(
        out["event_date"].astype(str) + " " + out["event_time"].astype(str),
        errors="coerce",
    )
    out["_event_date_only"] = out["_event_date_dt"].dt.date
    return out


def render_history_tab():
    st.markdown("## üìö ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á")

    try:
        df = load_sheet_df()
    except Exception as e:
        st.error(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return

    if df.empty:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets")
        return

    df = parse_event_datetime_columns(df)

    valid_dates_series = df["_event_date_dt"].dropna()
    if valid_dates_series.empty:
        min_d = date.today()
        max_d = date.today()
    else:
        min_d = valid_dates_series.min().date()
        max_d = valid_dates_series.max().date()

    if max_d < min_d:
        min_d, max_d = max_d, min_d

    st.markdown("### ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á")
    c1, c2, c3, c4 = st.columns([1, 1, 1.1, 1.5])
    with c1:
        start_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°", value=min_d, key="hist_start")
    with c2:
        end_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", value=max_d, key="hist_end")
    with c3:
        sev_selected = st.multiselect(
            "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á",
            options=sorted([x for x in df["severity_level"].dropna().astype(str).unique() if str(x).strip()]),
            default=[],
            key="hist_sev",
        )
    with c4:
        keyword = st.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)", key="hist_kw").strip()

    c5, c6 = st.columns([1, 2])
    with c5:
        unit_selected = st.multiselect(
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢",
            options=sorted([x for x in df["unit_name"].dropna().astype(str).unique() if str(x).strip()]),
            default=[],
            key="hist_unit",
        )
    with c6:
        group_selected = st.multiselect(
            "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
            options=sorted([x for x in df["incident_group"].dropna().astype(str).unique() if str(x).strip()]),
            default=[],
            key="hist_group",
        )

    if start_date > end_date:
        st.warning("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
        start_date, end_date = end_date, start_date

    m = pd.Series(True, index=df.index)
    m &= df["_event_date_only"].notna()
    m &= (df["_event_date_only"] >= start_date) & (df["_event_date_only"] <= end_date)

    if sev_selected:
        m &= df["severity_level"].astype(str).isin(sev_selected)

    if unit_selected:
        m &= df["unit_name"].astype(str).isin(unit_selected)

    if group_selected:
        m &= df["incident_group"].astype(str).isin(group_selected)

    if keyword:
        kw = keyword.lower()
        m &= (
            df["event_code"].astype(str).str.lower().str.contains(kw, na=False)
            | df["event_topic"].astype(str).str.lower().str.contains(kw, na=False)
            | df["event_display"].astype(str).str.lower().str.contains(kw, na=False)
            | df["incident_detail"].astype(str).str.lower().str.contains(kw, na=False)
            | df["rca_text"].astype(str).str.lower().str.contains(kw, na=False)
            | df["development_plan"].astype(str).str.lower().str.contains(kw, na=False)
        )

    filtered = df[m].copy()

    filtered["_created_at_dt"] = pd.to_datetime(filtered.get("created_at", ""), errors="coerce")
    filtered = filtered.sort_values(
        by=["_event_datetime", "_created_at_dt"],
        ascending=False,
        na_position="last",
    )

    st.markdown(f"**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:** {len(filtered):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

    if not filtered.empty:
        s1, s2, s3 = st.columns(3)
        with s1:
            st.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", f"{len(filtered):,}")
        with s2:
            st.metric(
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢",
                f"{filtered['unit_name'].astype(str).replace('', pd.NA).dropna().nunique():,}",
            )
        with s3:
            st.metric(
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
                f"{filtered['incident_group'].astype(str).replace('', pd.NA).dropna().nunique():,}",
            )

    display_cols = [
        "event_date",
        "event_time",
        "unit_name",
        "incident_group",
        "event_code",
        "event_topic",
        "severity_level",
        "severity_scheme",
        "incident_detail",
        "timeline_text",
        "initial_correction",
        "rca_text",
        "rca_image_filename",
        "rca_image_drive_url",
        "development_plan",
        "created_at",
        "created_by",
    ]
    for c in display_cols:
        if c not in filtered.columns:
            filtered[c] = ""

    st.dataframe(
        filtered[display_cols],
        use_container_width=True,
        hide_index=True,
        column_config={
            "event_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
            "event_time": "‡πÄ‡∏ß‡∏•‡∏≤",
            "unit_name": "‡∏´‡∏ô‡πà‡∏ß‡∏¢",
            "incident_group": "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
            "event_code": "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
            "event_topic": "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
            "severity_level": "‡∏£‡∏∞‡∏î‡∏±‡∏ö",
            "severity_scheme": "‡∏™‡πÄ‡∏Å‡∏•",
            "incident_detail": "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
            "timeline_text": "‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå",
            "initial_correction": "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô",
            "rca_text": "RCA (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)",
            "rca_image_filename": "‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö",
            "rca_image_drive_url": "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û (Drive)",
            "development_plan": "‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤",
            "created_at": "‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
            "created_by": "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        },
    )

    csv_bytes = filtered[display_cols].to_csv(index=False).encode("utf-8-sig")
    st.download_button(
        "‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (CSV)",
        data=csv_bytes,
        file_name=f"incident_history_{datetime.now().strftime('%Y%m%d_%H%M')}.csv",
        mime="text/csv",
        use_container_width=False,
    )

    with st.expander("üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)"):
        preview = filtered.head(20).copy()
        if preview.empty:
            st.write("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
        else:
            labels = []
            for _, r in preview.iterrows():
                labels.append(
                    f"{r.get('event_date','')} {r.get('event_time','')} | "
                    f"{r.get('unit_name','-')} | "
                    f"{r.get('event_code','-')} | ‡∏£‡∏∞‡∏î‡∏±‡∏ö {r.get('severity_level','-')}"
                )
            selected_idx = st.selectbox(
                "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
                options=list(range(len(labels))),
                format_func=lambda i: labels[i],
                key="hist_detail_picker",
            )
            row = preview.iloc[int(selected_idx)]

            st.markdown("### ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
            st.write(f"**‡∏´‡∏ô‡πà‡∏ß‡∏¢:** {row.get('unit_name','')}")
            st.write(f"**‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:** {row.get('incident_group','')}")
            st.write(f"**‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:** {row.get('event_code','')}")
            st.write(f"**‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:** {row.get('event_topic','')}")
            st.write(f"**‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á:** {row.get('severity_level','')} ({row.get('severity_scheme','')})")

            st.markdown("### ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå")
            st.write(row.get("incident_detail", ""))

            st.markdown("### ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå")
            st.write(row.get("timeline_text", ""))

            st.markdown("### ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô")
            st.write(row.get("initial_correction", ""))

            st.markdown("### RCA")
            st.write(row.get("rca_text", ""))

            drive_url = str(row.get("rca_image_drive_url", "")).strip()
            if drive_url:
                st.markdown("### ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (Google Drive)")
                st.markdown(f"[‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ö‡∏ô Google Drive]({drive_url})")

            st.markdown("### ‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤")
            st.write(row.get("development_plan", ""))

            if str(row.get("rca_image_filename", "")).strip():
                st.caption(f"‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {row.get('rca_image_filename')}")

‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ó‡∏µ (‡∏Å‡∏•‡∏±‡∏ß‡∏á‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏∏‡∏î)

# =========================
# MAIN
# =========================

def render_header():
    left_spacer, right_btn = st.columns([8.8, 1.2])
    with right_btn:
        if st.button("üö™ Logout", use_container_width=True):
            st.session_state.authenticated = False
            st.session_state.login_username = ""
            st.session_state.show_fishbone_preview = False
            st.rerun()

def check_required_env():
    missing = []
    for key in ["GSHEET_URL", "GCP_SERVICE_ACCOUNT_JSON"]:
        if not CFG.get(key):
            missing.append(key)

    if missing:
        st.error("‡∏¢‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: " + ", ".join(missing))
        st.stop()

    if not str(CFG.get("GDRIVE_FOLDER_ID", "") or "").strip():
        st.warning(
            "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GDRIVE_FOLDER_ID ‚Üí ‡∏´‡∏≤‡∏Å‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏õ Google Drive ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"
        )


def main():
    ensure_auth_state()

    if not st.session_state.authenticated:
        render_login()
        return

    check_required_env()

    render_header()    

    tab1, tab2 = st.tabs(["‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á"])

    with tab1:
        render_entry_tab()

    with tab2:
        render_history_tab()


if __name__ == "__main__":
    main()
